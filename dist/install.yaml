apiVersion: v1
kind: Namespace
metadata:
  labels:
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: model-operator
    control-plane: controller-manager
  name: model-operator-system
---
apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  annotations:
    controller-gen.kubebuilder.io/version: v0.19.0
  name: models.models.main-currents.news
spec:
  group: models.main-currents.news
  names:
    kind: Model
    listKind: ModelList
    plural: models
    singular: model
  scope: Namespaced
  versions:
  - additionalPrinterColumns:
    - jsonPath: .status.phase
      name: Phase
      type: string
    - jsonPath: .spec.version
      name: Version
      type: string
    - jsonPath: .spec.storage.size
      name: Size
      type: string
    - jsonPath: .metadata.creationTimestamp
      name: Age
      type: date
    name: v1alpha1
    schema:
      openAPIV3Schema:
        description: Model is the Schema for the models API
        properties:
          apiVersion:
            description: |-
              APIVersion defines the versioned schema of this representation of an object.
              Servers should convert recognized schemas to the latest internal value, and
              may reject unrecognized values.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources
            type: string
          kind:
            description: |-
              Kind is a string value representing the REST resource this object represents.
              Servers may infer this from the endpoint the client submits requests to.
              Cannot be updated.
              In CamelCase.
              More info: https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds
            type: string
          metadata:
            type: object
          spec:
            description: ModelSpec defines the desired state of Model
            properties:
              credentialsSecret:
                description: |-
                  CredentialsSecret references a Secret containing credentials
                  For HuggingFace: key "HF_TOKEN"
                  For S3: keys "AWS_ACCESS_KEY_ID" and "AWS_SECRET_ACCESS_KEY"
                type: string
              modelfile:
                description: Modelfile defines Ollama-style configuration (template,
                  system prompt, parameters)
                properties:
                  from:
                    description: |-
                      From overrides the FROM directive in the Modelfile
                      If not set, defaults to "/models"
                    type: string
                  huggingFacePath:
                    description: |-
                      HuggingFacePath sets the HUGGINGFACE_PATH comment in the Modelfile
                      If not set, auto-generated from source.huggingFace.repoId
                    type: string
                  parameters:
                    description: Parameters are model inference parameters
                    properties:
                      numCtx:
                        description: NumCtx context window size
                        type: integer
                      numGpu:
                        description: NumGPU number of GPU layers to offload
                        type: integer
                      repeatPenalty:
                        description: RepeatPenalty penalizes repetition (1.0 = no
                          penalty)
                        type: string
                      seed:
                        description: Seed for reproducibility (-1 for random)
                        type: integer
                      stop:
                        description: Stop sequences that halt generation
                        items:
                          type: string
                        type: array
                      temperature:
                        description: Temperature controls randomness (0.0-2.0)
                        type: string
                      topK:
                        description: TopK limits token selection to top K options
                        type: integer
                      topP:
                        description: TopP nucleus sampling parameter (0.0-1.0)
                        type: string
                    type: object
                  system:
                    description: System is the system prompt
                    type: string
                  template:
                    description: Template is the prompt template for the model
                    type: string
                type: object
              nodeSelector:
                additionalProperties:
                  type: string
                description: NodeSelector for the download Job
                type: object
              source:
                description: Source defines where to download the model from
                properties:
                  git:
                    description: Git source for Git repositories (with optional LFS
                      support)
                    properties:
                      depth:
                        default: 1
                        description: Depth for shallow clone (0 = full clone)
                        type: integer
                      exclude:
                        description: Exclude patterns to remove after checkout (e.g.,
                          ["*.bin", "*.h5"])
                        items:
                          type: string
                        type: array
                      include:
                        description: |-
                          Include patterns for sparse checkout (e.g., ["*.safetensors", "config.json"])
                          Uses git sparse-checkout with cone mode disabled for glob support
                        items:
                          type: string
                        type: array
                      lfs:
                        default: true
                        description: LFS enables Git LFS for large file downloads
                        type: boolean
                      ref:
                        default: main
                        description: Ref is the git reference (branch, tag, or commit)
                        type: string
                      url:
                        description: URL is the Git repository URL
                        type: string
                    required:
                    - url
                    type: object
                  huggingFace:
                    description: HuggingFace source configuration
                    properties:
                      exclude:
                        description: Exclude patterns for files to skip (e.g., ["*.bin",
                          "*.h5"])
                        items:
                          type: string
                        type: array
                      include:
                        description: Include patterns for files to download (e.g.,
                          ["*.safetensors", "*.json"])
                        items:
                          type: string
                        type: array
                      repoId:
                        description: RepoID is the HuggingFace repository ID (e.g.,
                          "meta-llama/Llama-3.1-8B-Instruct")
                        pattern: ^[a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+$
                        type: string
                      revision:
                        default: main
                        description: Revision is the git revision (branch, tag, or
                          commit hash)
                        type: string
                    required:
                    - repoId
                    type: object
                  s3:
                    description: S3 source for S3-compatible storage
                    properties:
                      bucket:
                        description: Bucket name
                        type: string
                      endpoint:
                        description: Endpoint for S3-compatible storage (e.g., MinIO)
                        type: string
                      key:
                        description: Key is the object key or prefix
                        type: string
                      region:
                        description: Region for AWS S3
                        type: string
                    required:
                    - bucket
                    - key
                    type: object
                  url:
                    description: URL source for direct HTTP/HTTPS downloads
                    properties:
                      url:
                        description: URL is the direct download URL
                        pattern: ^https?://
                        type: string
                    required:
                    - url
                    type: object
                type: object
              storage:
                description: Storage defines PVC configuration
                properties:
                  accessModes:
                    default:
                    - ReadWriteOnce
                    description: AccessModes for the PVC
                    items:
                      type: string
                    type: array
                  size:
                    description: Size of the PVC (e.g., "20Gi")
                    pattern: ^[0-9]+[KMGTPE]i?$
                    type: string
                  storageClass:
                    description: StorageClass name (e.g., "longhorn", "gp3")
                    type: string
                required:
                - size
                - storageClass
                type: object
              version:
                description: Version is an optional version identifier for tracking
                type: string
            required:
            - source
            - storage
            type: object
          status:
            description: ModelStatus defines the observed state of Model
            properties:
              conditions:
                description: Conditions provide detailed status information
                items:
                  description: Condition contains details for one aspect of the current
                    state of this API Resource.
                  properties:
                    lastTransitionTime:
                      description: |-
                        lastTransitionTime is the last time the condition transitioned from one status to another.
                        This should be when the underlying condition changed.  If that is not known, then using the time when the API field changed is acceptable.
                      format: date-time
                      type: string
                    message:
                      description: |-
                        message is a human readable message indicating details about the transition.
                        This may be an empty string.
                      maxLength: 32768
                      type: string
                    observedGeneration:
                      description: |-
                        observedGeneration represents the .metadata.generation that the condition was set based upon.
                        For instance, if .metadata.generation is currently 12, but the .status.conditions[x].observedGeneration is 9, the condition is out of date
                        with respect to the current state of the instance.
                      format: int64
                      minimum: 0
                      type: integer
                    reason:
                      description: |-
                        reason contains a programmatic identifier indicating the reason for the condition's last transition.
                        Producers of specific condition types may define expected values and meanings for this field,
                        and whether the values are considered a guaranteed API.
                        The value should be a CamelCase string.
                        This field may not be empty.
                      maxLength: 1024
                      minLength: 1
                      pattern: ^[A-Za-z]([A-Za-z0-9_,:]*[A-Za-z0-9_])?$
                      type: string
                    status:
                      description: status of the condition, one of True, False, Unknown.
                      enum:
                      - "True"
                      - "False"
                      - Unknown
                      type: string
                    type:
                      description: type of condition in CamelCase or in foo.example.com/CamelCase.
                      maxLength: 316
                      pattern: ^([a-z0-9]([-a-z0-9]*[a-z0-9])?(\.[a-z0-9]([-a-z0-9]*[a-z0-9])?)*/)?(([A-Za-z0-9][-A-Za-z0-9_.]*)?[A-Za-z0-9])$
                      type: string
                  required:
                  - lastTransitionTime
                  - message
                  - reason
                  - status
                  - type
                  type: object
                type: array
                x-kubernetes-list-map-keys:
                - type
                x-kubernetes-list-type: map
              message:
                description: Message is a human-readable status message
                type: string
              observedGeneration:
                description: ObservedGeneration is the last observed generation
                format: int64
                type: integer
              phase:
                description: Phase indicates the current state
                enum:
                - Pending
                - Downloading
                - Ready
                - Failed
                type: string
              progress:
                description: Progress is the download progress (0-100)
                maximum: 100
                minimum: 0
                type: integer
              pvcName:
                description: PVCName is the name of the created PVC
                type: string
            type: object
        required:
        - spec
        type: object
    served: true
    storage: true
    subresources:
      status: {}
---
apiVersion: v1
kind: ServiceAccount
metadata:
  labels:
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: model-operator
  name: model-operator-controller-manager
  namespace: model-operator-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  labels:
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: model-operator
  name: model-operator-leader-election-role
  namespace: model-operator-system
rules:
- apiGroups:
  - ""
  resources:
  - configmaps
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
- apiGroups:
  - coordination.k8s.io
  resources:
  - leases
  verbs:
  - get
  - list
  - watch
  - create
  - update
  - patch
  - delete
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - create
  - patch
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: model-operator-manager-role
rules:
- apiGroups:
  - ""
  resources:
  - events
  verbs:
  - create
  - patch
- apiGroups:
  - ""
  resources:
  - persistentvolumeclaims
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - ""
  resources:
  - pods
  - secrets
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - batch
  resources:
  - jobs
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - models.main-currents.news
  resources:
  - models
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - models.main-currents.news
  resources:
  - models/finalizers
  verbs:
  - update
- apiGroups:
  - models.main-currents.news
  resources:
  - models/status
  verbs:
  - get
  - patch
  - update
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: model-operator-metrics-auth-role
rules:
- apiGroups:
  - authentication.k8s.io
  resources:
  - tokenreviews
  verbs:
  - create
- apiGroups:
  - authorization.k8s.io
  resources:
  - subjectaccessreviews
  verbs:
  - create
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: model-operator-metrics-reader
rules:
- nonResourceURLs:
  - /metrics
  verbs:
  - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: model-operator
  name: model-operator-model-admin-role
rules:
- apiGroups:
  - models.main-currents.news
  resources:
  - models
  verbs:
  - '*'
- apiGroups:
  - models.main-currents.news
  resources:
  - models/status
  verbs:
  - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: model-operator
  name: model-operator-model-editor-role
rules:
- apiGroups:
  - models.main-currents.news
  resources:
  - models
  verbs:
  - create
  - delete
  - get
  - list
  - patch
  - update
  - watch
- apiGroups:
  - models.main-currents.news
  resources:
  - models/status
  verbs:
  - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  labels:
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: model-operator
  name: model-operator-model-viewer-role
rules:
- apiGroups:
  - models.main-currents.news
  resources:
  - models
  verbs:
  - get
  - list
  - watch
- apiGroups:
  - models.main-currents.news
  resources:
  - models/status
  verbs:
  - get
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  labels:
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: model-operator
  name: model-operator-leader-election-rolebinding
  namespace: model-operator-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: model-operator-leader-election-role
subjects:
- kind: ServiceAccount
  name: model-operator-controller-manager
  namespace: model-operator-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  labels:
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: model-operator
  name: model-operator-manager-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: model-operator-manager-role
subjects:
- kind: ServiceAccount
  name: model-operator-controller-manager
  namespace: model-operator-system
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: model-operator-metrics-auth-rolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: model-operator-metrics-auth-role
subjects:
- kind: ServiceAccount
  name: model-operator-controller-manager
  namespace: model-operator-system
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: model-operator
    control-plane: controller-manager
  name: model-operator-controller-manager-metrics-service
  namespace: model-operator-system
spec:
  ports:
  - name: https
    port: 8443
    protocol: TCP
    targetPort: 8443
  selector:
    app.kubernetes.io/name: model-operator
    control-plane: controller-manager
---
apiVersion: v1
kind: Service
metadata:
  labels:
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: model-operator
  name: model-operator-webhook-service
  namespace: model-operator-system
spec:
  ports:
  - port: 443
    protocol: TCP
    targetPort: 9443
  selector:
    control-plane: controller-manager
---
apiVersion: apps/v1
kind: Deployment
metadata:
  labels:
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: model-operator
    control-plane: controller-manager
  name: model-operator-controller-manager
  namespace: model-operator-system
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: model-operator
      control-plane: controller-manager
  template:
    metadata:
      annotations:
        kubectl.kubernetes.io/default-container: manager
      labels:
        app.kubernetes.io/name: model-operator
        control-plane: controller-manager
    spec:
      containers:
      - args:
        - --metrics-bind-address=:8443
        - --leader-elect
        - --health-probe-bind-address=:8081
        command:
        - /manager
        image: gcr.io/rsJames-ttrpg/model-operator/model-operator:latest
        livenessProbe:
          httpGet:
            path: /healthz
            port: 8081
          initialDelaySeconds: 15
          periodSeconds: 20
        name: manager
        ports:
        - containerPort: 9443
          name: webhook-server
          protocol: TCP
        readinessProbe:
          httpGet:
            path: /readyz
            port: 8081
          initialDelaySeconds: 5
          periodSeconds: 10
        resources:
          limits:
            cpu: 500m
            memory: 128Mi
          requests:
            cpu: 10m
            memory: 64Mi
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
        volumeMounts:
        - mountPath: /tmp/k8s-webhook-server/serving-certs
          name: cert
          readOnly: true
      securityContext:
        runAsNonRoot: true
        seccompProfile:
          type: RuntimeDefault
      serviceAccountName: model-operator-controller-manager
      terminationGracePeriodSeconds: 10
      volumes:
      - name: cert
        secret:
          defaultMode: 420
          secretName: webhook-server-cert
---
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  labels:
    app.kubernetes.io/component: certificate
    app.kubernetes.io/created-by: model-operator
    app.kubernetes.io/instance: serving-cert
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: certificate
    app.kubernetes.io/part-of: model-operator
  name: model-operator-serving-cert
  namespace: model-operator-system
spec:
  dnsNames:
  - model-operator-webhook-service.model-operator-system.svc
  - model-operator-webhook-service.model-operator-system.svc.cluster.local
  issuerRef:
    kind: Issuer
    name: model-operator-selfsigned-issuer
  secretName: webhook-server-cert
---
apiVersion: cert-manager.io/v1
kind: Issuer
metadata:
  labels:
    app.kubernetes.io/managed-by: kustomize
    app.kubernetes.io/name: model-operator
  name: model-operator-selfsigned-issuer
  namespace: model-operator-system
spec:
  selfSigned: {}
---
apiVersion: admissionregistration.k8s.io/v1
kind: MutatingWebhookConfiguration
metadata:
  annotations:
    cert-manager.io/inject-ca-from: model-operator-system/model-operator-serving-cert
  name: model-operator-mutating-webhook-configuration
webhooks:
- admissionReviewVersions:
  - v1
  clientConfig:
    service:
      name: model-operator-webhook-service
      namespace: model-operator-system
      path: /mutate-v1-pod
  failurePolicy: Ignore
  name: model-injector.models.main-currents.news
  rules:
  - apiGroups:
    - ""
    apiVersions:
    - v1
    operations:
    - CREATE
    resources:
    - pods
  sideEffects: None
